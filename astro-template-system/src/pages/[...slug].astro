---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getSection } from '../utils/sectionRegistry';

// Get all sites
export async function getStaticPaths() {
  // NOTE: Astro hoists `getStaticPaths()` outside the component function.
  // Any frontmatter `const` values may end up scoped to the component only,
  // so read env vars inside `getStaticPaths()` to avoid "is not defined" at build time.
  const activeSiteId = process.env.PROMAKLER_SITE_ID || '';
  const sites = await getCollection('sites');
  const selectedSites = activeSiteId
    ? sites.filter((site) => site.data?.meta?.domain === activeSiteId)
    : sites;

  if (activeSiteId && selectedSites.length === 0) {
    console.warn(
      `[promakler] PROMAKLER_SITE_ID=${activeSiteId} did not match any site (by meta.domain).`
    );
  }
  
  const paths = [];
  
  for (const site of selectedSites) {
    for (const page of site.data.pages) {
      // Backward-compat: older exports used "home" instead of "/" for the homepage.
      const normalizedSlug = page.slug === 'home' ? '/' : page.slug;
      paths.push({
        params: { 
          slug: normalizedSlug === '/' ? undefined : normalizedSlug.replace(/^\//, '')
        },
        props: { 
          site: site.data,
          page 
        }
      });
    }
  }
  
  return paths;
}

const { site, page } = Astro.props;
const { meta } = site;

// Sort sections by order
const sortedSections = [...page.sections]
  .filter(s => s.visible !== false)
  .sort((a, b) => a.order - b.order);
---

<BaseLayout 
  title={page.title}
  description={page.description}
  brand={meta.brand}
  contact={meta.contact}
  sectionStylePreset={meta.sectionStylePreset}
>
  {sortedSections.map(section => {
    const Component = getSection(section.type, section.variant);
    
    if (!Component) {
      return (
        <div class="section-error">
          <p>Section {section.type}:{section.variant} not found</p>
        </div>
      );
    }

    // Pass brand and contact to footer and contact sections
    const props = (section.type === 'footer' || section.type === 'contact')
      ? { ...section.props, brand: meta.brand, contact: meta.contact }
      : section.props;

    return <Component {...props} />;
  })}
</BaseLayout>

<style>
  .section-error {
    padding: var(--spacing-2xl);
    background: #fee;
    border: 2px solid #c00;
    border-radius: var(--radius-md);
    text-align: center;
    color: #c00;
  }
</style>
